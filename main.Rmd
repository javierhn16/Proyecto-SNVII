---
title: "main"
output: html_document
---

```{r}
pacman::p_load(tidyverse, lubridate, ggplot2, scales)
```

```{r,message=FALSE}
data <- read_csv("data/ausautoBI8999.csv") %>%
  mutate(
    AccDate = as.Date(AccDate),
    ReportDate = as.Date(ReportDate),
    FinDate = as.Date(FinDate),
    delay = as.numeric(ReportMth - AccMth),
    duration = as.numeric(FinMth - AccMth)
  ) %>%
  select(-c(4:6,8:14))
```

```{r}
fig <- ggplot(data, aes(x = log(AggClaim))) +
  geom_density(color = "lightblue", size = 1.3, adjust = 1.2, fill = "lightblue") +
  geom_histogram(aes(y = ..density..), 
                 fill = "#0073C2FF", color = "white", bins = 50, alpha = 0.6) +
  labs(
    x = "Monto del reclamo (escala log)",
    y = "Densidad"
  ) +
  theme_minimal()
ggsave("res/densidad.pdf", fig, width = 8, height = 4)
```


```{r, message=FALSE}
fig <- data %>%
  mutate(month = floor_date(AccDate, "month")) %>%
  group_by(month) %>%
  summarise(Reclamos = n()) %>%
  ggplot(aes(x = month, y = Reclamos)) +
  geom_line(color = "#E69F00", linewidth = 1) +
  geom_point(color = "#F17F00", size = 1.5) +
  geom_smooth(method = "loess", se = FALSE, color = "#0072B2") +  
  labs(
    x = "Fecha del accidente (mes)",
    y = "NÃºmero de reclamos"
  ) +
  theme_minimal()
ggsave("res/evol.pdf", fig, width = 8, height = 4)
```


```{r}
fig <- ggplot(data, aes(x = log(AggClaim), y = OpTime)) +
  geom_density_2d_filled(contour_var = "density", alpha = 0.85) +
  scale_fill_manual(
    values = colorRampPalette(c("#02102a", "#3182bd", "#fef0d9", "gray")[4:1])(13)
  ) +
  labs(
    x = "Monto agregado del reclamo (escala log)",
    y = "Tiempo operativo (OpTime)",
    fill = "Densidad"
  ) +
  theme_minimal()
ggsave("res/calor.pdf", fig, width = 8, height = 4)
```


```{r}
datos_sli <- data %>%
  filter(AccDate > as.Date("1992-12-31")) %>%
  mutate(
    ocurrencia = year(AccDate),
    reporte = year(ReportDate),
    k  = pmax(0, reporte - ocurrencia)
  ) %>%
  group_by(ocurrencia, k) %>%
  summarise(inc = sum(AggClaim, na.rm = TRUE), .groups = "drop")

  triangulo <- pivot_wider(datos_sli, names_from = k, values_from = inc, values_fill = 0) %>%
    arrange(ocurrencia)
  triangulo <- data.frame(triangulo)
  rownames(triangulo) <- triangulo[, 1]  
  triangulo <- triangulo[, -1]           
  colnames(triangulo) <- 0:max(datos_sli$k, na.rm = TRUE)
```




