---
title: "main"
output: html_document
---

```{r}
pacman::p_load(tidyverse, lubridate, ggplot2, scales)
```

```{r,message=FALSE}
data <- read_csv("data/ausautoBI8999.csv") %>%
  mutate(
    AccDate = as.Date(AccDate),
    ReportDate = as.Date(ReportDate),
    FinDate = as.Date(FinDate),
    delay = as.numeric(ReportDate - AccDate),
    duration = as.numeric(FinDate - AccDate)
  ) %>%
  select(-c(4:6,8:14))
```

```{r}
ggplot(data, aes(x = AggClaim)) +
  geom_histogram(fill = "#0073C2FF", color = "white", bins = 50) +
  scale_x_log10(labels = comma) +
  labs(
    title = "Distribución del monto agregado de reclamos (log)",
    x = "Monto del reclamo (escala log10)",
    y = "Frecuencia"
  ) +
  theme_minimal()

## --- Distribución del tiempo operativo (OpTime)
ggplot(data, aes(x = OpTime)) +
  geom_histogram(bins = 40, fill = "#56B4E9", color = "white") +
  labs(
    title = "Distribución del tiempo operativo",
    x = "OpTime",
    y = "Frecuencia"
  ) +
  theme_minimal()

## --- Evolución temporal de reclamos por fecha de accidente
data %>%
  mutate(month = floor_date(AccDate, "month")) %>%
  group_by(month) %>%
  summarise(Reclamos = n()) %>%
  ggplot(aes(x = month, y = Reclamos)) +
  geom_line(color = "#D55E00", linewidth = 1) +
  geom_point(color = "#D55E00", size = 1.5) +
  labs(
    title = "Evolución temporal de reclamos",
    x = "Fecha del accidente (mes)",
    y = "Número de reclamos"
  ) +
  theme_minimal()

## --- Relación entre delay (reporte) y monto del reclamo
ggplot(data, aes(x = delay, y = AggClaim)) +
  geom_point(alpha = 0.3, color = "#0072B2") +
  scale_y_log10(labels = comma) +
  labs(
    title = "Relación entre días de retraso en reporte y monto del reclamo",
    x = "Retraso (días entre accidente y reporte)",
    y = "Monto del reclamo (log10)"
  ) +
  theme_minimal()
```

```{r}
datos_sli <- data %>%
  filter(AccDate > as.Date("1992-12-31")) %>%
  mutate(
    ocurrencia = year(AccDate),
    reporte = year(ReportDate),
    k  = pmax(0, reporte - ocurrencia)
  ) %>%
  group_by(ocurrencia, k) %>%
  summarise(inc = sum(AggClaim, na.rm = TRUE), .groups = "drop")

  triangulo <- pivot_wider(datos_sli, names_from = k, values_from = inc, values_fill = 0) %>%
    arrange(ocurrencia)
  triangulo <- data.frame(triangulo)
  rownames(triangulo) <- triangulo[, 1]  
  triangulo <- triangulo[, -1]           
  colnames(triangulo) <- 0:max(datos_sli$k, na.rm = TRUE)
```




